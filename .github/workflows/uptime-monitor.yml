name: Uptime Monitoring

on:
  schedule:
    - cron: '*/15 * * * *'  # Every 15 minutes
  workflow_dispatch:

jobs:
  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Check API Health
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" https://311.westwindsorforward.org/api/health || echo "000")
          
          if [ "$response" != "200" ]; then
            echo "::error::API health check failed with status: $response"
            exit 1
          fi
          
          echo "âœ… API health check passed (HTTP $response)"

      - name: Check Frontend
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" https://311.westwindsorforward.org || echo "000")
          
          if [ "$response" != "200" ]; then
            echo "::error::Frontend health check failed with status: $response"
            exit 1
          fi
          
          echo "âœ… Frontend health check passed (HTTP $response)"

      - name: Notify on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ Production Down Alert',
              body: `## Production Health Check Failed\n\n**Time:** ${new Date().toISOString()}\n**Run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}\n\nPlease investigate immediately.`,
              labels: ['urgent', 'production']
            });
